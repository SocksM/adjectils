<!DOCTYPE html>
  <html>
  <body onload="updatePage()">
  <title>adjectils - Dungeons</title>
  <link rel="stylesheet" href="stylesheet.css">
  <meta name = "description" content = "Decrepit utilities for Hypixel SkyBlock">
  <meta name = "author" content = "adjective_n0un">
  <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
  <link rel="manifest" href="./favicon/site.webmanifest">
  <script type="text/javascript" src="jquery-3.6.3.min.js"></script>
      <script>
      $(function(){
        $("#nav").load("nav.html"); 
      });
      </script>
  <div style = "text-align:center">
    <a href = "index.html" class = adjheader>adjectils</a><span class = header>&nbsp;|&nbsp;</span><span class = cataheader>Dungeons</span><br>
  </div>
  <br>
  <div style = "text-align:center">
  <span style = "color:#282828"></span><input type = "text" id = "nameinput" onchange = updateCata(value)><span>&nbsp;</span><button onclick = updateCata(nameinput.value) style = "width: 5%;  text-align:center">Refresh âŸ³</button><br>
  <span id = "refreshstatus"></span><br>
  <span id = "status"></span><br>
  <span id = "otherstatus"></span><br>
  <div>
    <form action = "#" style = "background-color: #282828;">
      <label>Profile:</label>
      <select id = profileid value = 4 onchange = updateCata(nameinput.value)>
        <option id = profile0 value = 0>â€“â€“â€“â€“â€“</option>
        <option id = profile1 value = 1>â€“â€“â€“â€“â€“</option>
        <option id = profile2 value = 2>â€“â€“â€“â€“â€“</option>
        <option id = profile3 value = 3>â€“â€“â€“â€“â€“</option>
        <option id = profile4 value = 4>â€“â€“â€“â€“â€“</option>
      </select>
    </form>
  </div>
  </div>
  <br>
  <section class = "flex_box_cata" style = "margin:auto">
    <div class = "flex_index_row" style = "width:95%; align-items: stretch;">
        <div class = "flex_cata_box" style = "width:29%;">
            <span class = header class = "flex_full_row" style = "margin-bottom: 20px;">Current levels</span>
            <table style = "width:100%">
            <tr><td class = "flex_full_row" style = "margin-bottom: 18px;"><span class = "flex_full_row">Daily runs remaining: </span></td><td><span id = "dailyruns" class = "flex_align_right" style = "margin-bottom:18px"></span></td></tr>
            <tr><td class = "flex_full_row"><span class = "flex_full_row">Catacombs Level: </span></td><td><span id = "catalevel" class = "flex_align_right"></span></td></tr>
            <tr><td class = "flex_full_row"></td><td><span id = "catapercent" class = "flex_align_right" style = "font-size: 10px; margin-bottom: 6px;">...</span></td></tr>
            <tr><td><span class = "flex_full_row">Archer Level: </span></td><td><span id = "archlevel" class = "flex_align_right"></span></td></tr>
            <tr><td class = "flex_full_row"></td><td><span id = "archpercent" class = "flex_align_right" style = "font-size: 10px; margin-bottom: 6px;">...</span></td></tr>
            <tr><td><span class = "flex_full_row">Berserk Level: </span></td><td><span id = "berslevel" class = "flex_align_right"></span></td></tr>
            <tr><td class = "flex_full_row"></td><td><span id = "berspercent" class = "flex_align_right" style = "font-size: 10px; margin-bottom: 6px;">...</span></td></tr>
            <tr><td><span class = "flex_full_row">Healer Level: </span></td><td><span id = "heallevel" class = "flex_align_right"></span></td></tr>
            <tr><td class = "flex_full_row"></td><td><span id = "healpercent" class = "flex_align_right" style = "font-size: 10px; margin-bottom: 6px;">...</span></td></tr>
            <tr><td><span class = "flex_full_row">Mage Level: </span></td><td><span id = "magelevel" class = "flex_align_right"></span></td></tr>
            <tr><td class = "flex_full_row"></td><td><span id = "magepercent" class = "flex_align_right" style = "font-size: 10px; margin-bottom: 6px;">...</span></td></tr>
            <tr><td><span class = "flex_full_row">Tank Level: </span></td><td><span id = "tanklevel" class = "flex_align_right"></span></td></tr>
            <tr><td class = "flex_full_row"></td><td><span id = "tankpercent" class = "flex_align_right" style = "font-size: 10px; margin-bottom: 6px;">...</span></td></tr>
        </table>
            
        </div>
        <div class = "flex_cata_box" style = "width:69%;">
            <span class = header class = "flex_full_row">Milestone calculations</span>
            <span class = fineprint style = "display:flex; flex-basis:100%;">Note: For ease of calculation, it's assumed that each floor has been completed at least 25 times, and that a score of exactly 300 is reached every run.</span>
            <table>
            <tr><td>
                <form action = "#">
                    <label>Floor: </label>
                    <select id = "selectedfloor" onchange = updateCata(nameinput.value)>
                        <option value = 324000>M7</option>
                        <option value = 108000>M6</option>
                        <option value = 75600>M5</option>
                        <option value = 59400>M4</option>
                        <option value = 36800>M3</option>
                        <option value = 21600>M2</option>
                        <option value = 16200>M1</option>
                        <option value = 30240>F7</option>
                        <option value = 5270.4>F6</option>
                        <option value = 2592>F5</option>
                        <option value = 1533.6>F4</option>
                        <option value = 604.8>F3</option>
                        <option value = 237.6>F2</option>
                        <option value = 118.8>F1</option>
                        <option value = 59.4>Entrance</option>
                    </select>
                    <label>Catacombs Expert Ring: </label>
                    <select id = "cataexpert" onchange = updateCata(nameinput.value)>
                        <option value = 0.1>Yes</option>
                        <option value = 0>No</option>
                    </select>
                    <label>Hecatomb Level: </label>
                    <select id = "hecatomb" onchange = updateCata(nameinput.value)>
                        <option value = 0.02>X</option>
                        <option value = 0.0184>IX</option>
                        <option value = 0.0168>VIII</option>
                        <option value = 0.0152>VII</option>
                        <option value = 0.0136>VI</option>
                        <option value = 0.012>V</option>
                        <option value = 0.0104>IV</option>
                        <option value = 0.0088>III</option>
                        <option value = 0.0072>II</option>
                        <option value = 0.0056>I</option>
                        <option value = 0>0</option>
                    </select>
                </form>
            </td></tr>
            </table>
            <table style = "width:100%">
            <tr><td><span>Runs until Catacombs </span><input id = "targetcata" type = "number" min = "1" max = "50" style = "width:40px;" value = "50" onchange = updateCata(nameinput.value)><span>: </span></td></td><td><span id = "cataruns" class = "flex_align_right"></span></td></tr>
            <tr><td><span class = "flex_full_row">Until Archer complete: <sup style = "font-size:8px"><span class = tip>ðŸ›ˆ<span class = tiptext style = "font-size: 12px;">"Completing" a class is defined as having the minimum amount of XP required to reach Class Average 50 by finishing a minimal number of runs using the other four classes.</span></span></sup></td><td><span id = "archruns" class = "flex_align_right"></span></td></tr>
            <tr><td><span class = "flex_full_row">Until Berserk complete: <sup style = "font-size:8px"><span class = tip>ðŸ›ˆ<span class = tiptext style = "font-size: 12px;">"Completing" a class is defined as having the minimum amount of XP required to reach Class Average 50 by finishing a minimal number of runs using the other four classes.</span></span></sup></td><td><span id = "bersruns" class = "flex_align_right"></span></td></tr>
            <tr><td><span class = "flex_full_row">Until Healer complete: <sup style = "font-size:8px"><span class = tip>ðŸ›ˆ<span class = tiptext style = "font-size: 12px;">"Completing" a class is defined as having the minimum amount of XP required to reach Class Average 50 by finishing a minimal number of runs using the other four classes.</span></span></sup></td><td><span id = "healruns" class = "flex_align_right"></span></td></tr>
            <tr><td><span class = "flex_full_row">Until Mage complete: <sup style = "font-size:8px"><span class = tip>ðŸ›ˆ<span class = tiptext style = "font-size: 12px;">"Completing" a class is defined as having the minimum amount of XP required to reach Class Average 50 by finishing a minimal number of runs using the other four classes.</span></span></sup></td><td><span id = "mageruns" class = "flex_align_right"></span></td></tr>
            <tr><td><span class = "flex_full_row">Until Tank complete: <sup style = "font-size:8px"><span class = tip>ðŸ›ˆ<span class = tiptext style = "font-size: 12px;">"Completing" a class is defined as having the minimum amount of XP required to reach Class Average 50 by finishing a minimal number of runs using the other four classes.</span></span></sup></td><td><span id = "tankruns" class = "flex_align_right"></span></td></tr>
            <tr><td><span class = "flex_full_row">Until Class Average 50: </span></td><td><span id = "totalruns" class = "flex_align_right"></span></td></tr>
            <tr><td><span class = "flex_full_row">Copyable text: </span></td><td class = "flex_align_right"><button onclick = copyText() style = "width: 40%;">Copy!</button></td></tr>
            </table>
        </div>
    </div>
  </section>

  <div id = "nav" style = "width:600px; margin:auto" class = "hub_block"></div>
  </body>
  <script src = "getUUID.js"></script>
  <script>
    const classxps = [50, 75, 110, 160, 230, 330, 470, 670, 950, 1340, 1890, 2665, 3760, 5260, 7380, 10300, 14400, 20000, 27600, 38000, 52500, 71500, 97000, 132000, 180000, 243000, 328000, 445000, 600000, 800000, 1065000, 1410000, 1900000, 2500000, 3300000, 4300000, 5600000, 7200000, 9200000, 12000000, 15000000, 19000000, 24000000, 30000000, 38000000, 48000000, 60000000, 75000000, 93000000, 116250000];
    var classes = ["archer", "berserk", "healer", "mage", "tank"];
    var classesabbrev = ["arch", "bers", "heal", "mage", "tank"];
    const totalxp = 569809640;
    var copyabletext = "";
    function updatePage(){
        if (localStorage.getItem("storedname") != null){
            console.log("Found a previous name and data! Loading...");
            console.log("Previous name: " + localStorage.getItem("storedname"));
            console.log("Previous data: " + localStorage.getItem("storeddata"));
            document.getElementById("nameinput").value = localStorage.getItem("storedname");
            data = JSON.parse(localStorage.getItem("storeddata"));
            fasttrack = true;
            updateCata(localStorage.getItem("storedname"));
        }
    }
    var data = undefined;
    var onCD = false;
    var profilelist;
    var UUID;
    function resetStatuses(){
      document.getElementById("dailyruns").innerText = "0";
      document.getElementById("status").innerText = "";
      document.getElementById("otherstatus").innerText = "";
      document.getElementById("catalevel").innerText = "...";
      document.getElementById("archlevel").innerText = "...";
      document.getElementById("berslevel").innerText = "...";
      document.getElementById("heallevel").innerText = "...";
      document.getElementById("magelevel").innerText = "...";
      document.getElementById("tanklevel").innerText = "...";
      document.getElementById("cataruns").innerText = "...";
      document.getElementById("archruns").innerText = "...";
      document.getElementById("bersruns").innerText = "...";
      document.getElementById("healruns").innerText = "...";
      document.getElementById("mageruns").innerText = "...";
      document.getElementById("tankruns").innerText = "...";
      document.getElementById("totalruns").innerText = "...";
    }
    var lastname = "";
    function abbreviate(input){
        if (input > 1000){
            if (input > 1000000){
                input = (input / 1000000).toFixed(1) + "M";
            } else {
                input = (input / 1000000).toFixed(1) + "K";
            }
        }
        return input;
    }
    var fasttrack = false;
    
    async function updateCata(name){
        resetStatuses();
        console.log("Last name: " + lastname + " New name: " + name);
        if (onCD == true){
            document.getElementById("refreshstatus").innerText = "Please wait 5 seconds before using this again.";
            console.log("On cooldown!");
            return -1;
        } else {
            document.getElementById("refreshstatus").innerText = "";
            if (!fasttrack){
                onCD = true;
                setTimeout(() => { onCD = false }, 5000);
            }
            
        }
        UUID = await getUUIDbyName(name);
        if (!fasttrack){
            data = await getAPIdata(UUID);
            console.log(data);
        } 
        try {
                console.log("Attempting to set profile ID...");
                profilelist = (data.profiles);
                for (var i = 0; i < 5; i++){
                    document.getElementById("profile" + i).innerText = "â€“â€“â€“â€“â€“";
                }
                for (var i = 0; i < profilelist.length; i++){
                    document.getElementById("profile" + i).innerText = profilelist[i].cute_name;
                }
          
                console.log("Checking new name");
                var profilenum = 0;
                lastname = name;
                for (var i = 0; i < profilelist.length; i++){
                    if (profilelist[i].selected){
                        console.log("Profile ID found: " + profilenum);
                        profilenum = i;
                        break;
                    }
                }
                document.getElementById("profileid").value = profilenum;    
            } catch (TypeError){
                document.getElementById("status").innerHTML = "<span class = errored>No profiles found</span>";
            }
            lastname = name;
            fasttrack = false;
            localStorage.setItem("storedname", name);
            console.log("Set item " + localStorage.getItem("storedname"));
            localStorage.setItem("storeddata", JSON.stringify(data)); 
            console.log("Set item " + localStorage.getItem("storeddata"));
        
        //try {
            console.log(data);
            var dungeons = data.profiles[profileid.value].members[UUID].dungeons;
            var cataxp =  dungeons.dungeon_types.catacombs.experience;
            var time = Math.floor(Date.now()/1000);
            var realdaylen = 86400;
            var realdaystamp = Math.floor(time / realdaylen);
            if (dungeons.daily_runs.current_day_stamp == realdaystamp){
                document.getElementById("dailyruns").innerText = Math.max(0, 5 - (dungeons.daily_runs.completed_runs_count));
            } else {
                document.getElementById("dailyruns").innerText = 5;
            }
            
            if (targetcata.value > 50) {
                targetcata.value = 50;
            }
            if (targetcata.value < 1) {
                targetcata.value = 1;
            }
            var targetcatalevel = targetcata.value;
            var targetcataxp = 0;
            for (var i = 0; i < targetcatalevel; i++){
                cataxp -= classxps[i];
                if (cataxp <= 0){
                    cataxp += (classxps[i]);
                    cataxp = Math.floor(cataxp);
                    document.getElementById("catalevel").innerText = i;
                    document.getElementById("catapercent").innerText = abbreviate(cataxp) + "/" + abbreviate(classxps[i]);
                    break;
                }
            }
            if (i == 50){
                console.log("Failsafe triggered, congrats on being cata " + targetcatalevel);
                document.getElementById("catalevel").innerText = targetcatalevel;
                document.getElementById("catapercent").innerText = "Congrats!";
            }
            //Set the levels of the classes
            
            for (var i = 0; i < 5; i++){
                var xp = dungeons.player_classes[classes[i]].experience;
                for (var j = 0; j < 50; j++){
                    xp -= classxps[j];
                    if (xp <= 0){
                        xp += (classxps[j]);
                        xp = Math.floor(xp);
                        //this is to avoid floating point rounding errors
                        var xppercent = Math.floor((xp/classxps[j]).toFixed(4) * 10000) / 100;
                        document.getElementById(classesabbrev[i] + "level").innerText = j;
                        document.getElementById(classesabbrev[i] + "percent").innerText = abbreviate(xp) + "/" + abbreviate(classxps[j]);
                        break;
                    }
                }
                if (j == 50){
                    console.log("Failsafe triggered, congrats on being " + classesabbrev[i] + " 50");
                    document.getElementById(classesabbrev[i] + "level").innerText = 50;
                    document.getElementById(classesabbrev[i] + "percent").innerText = "Congrats!";
                }
            }
            //Get remaining xps
            cataxp = dungeons.dungeon_types.catacombs.experience;
            for (var i = 0; i < targetcatalevel; i++){
                targetcataxp += classxps[i];
            }
            var cataxpleft = Math.max(targetcataxp - cataxp, 0);
            
            //a, b, h, m, t
            var classxpsleft = [
                Math.max(569809640 - dungeons.player_classes[classes[0]].experience, 0),
                Math.max(569809640 - dungeons.player_classes[classes[1]].experience, 0),
                Math.max(569809640 - dungeons.player_classes[classes[2]].experience, 0),
                Math.max(569809640 - dungeons.player_classes[classes[3]].experience, 0),
                Math.max(569809640 - dungeons.player_classes[classes[4]].experience, 0),
            ]   
            console.log(classxpsleft);
            //Sorts arrays into decreasing order - if i ever get back to optimizing this, i'll use this
            /*
            for (var i = 1; i < 5; i++){
                var key1 = classxpsleft[i];
                var key2 = classesabbrev[i];
                var key3 = classes[i];
                var j = i - 1;
                while (j >= 0 && classxpsleft[j] < key1){
                    classxpsleft[j + 1] = classxpsleft[j];
                    classesabbrev[j + 1] = classesabbrev[j];
                    classes[j + 1] = classes[j];
                    j--;
                }
                classxpsleft[j + 1] = key1;
                classesabbrev[j + 1] = key2;
                classes[j + 1] = key3;
            }
            */

            //Solve the class average problem
            //I could probably merge this with the previous loop somehow but im too lazy right now
            //O(n) solution, there is probably a O(1) solution somewhere but brooke is rushing me right now
            var cataperrun = selectedfloor.value * 1.38888888;
            cataperrun *= (1 + parseFloat(cataexpert.value) + parseFloat(hecatomb.value));
            cataperrun = Math.ceil(cataperrun);
            catarunsleft = Math.ceil(cataxpleft/cataperrun);
            classperrun = Math.ceil(cataperrun * (1/1.4));
            console.log(classxpsleft);
            console.log(classesabbrev);
            
            document.getElementById("cataruns").innerText = catarunsleft.toLocaleString();
            var runstoca50 = [0, 0, 0, 0, 0];  
            /* 
            var runsToEnd = [0, 0, 0, 0, 0];
            for (var i = 0; i < 5; i++){
                var toNext = classxpsleft[i] - classxpsleft[i + 1];
                runsToEnd[i] = Math.ceil(classxpsleft[i] / classperrun);
            }
            console.log(runsToEnd);
            */

            while (true){
                var allnegative = true;
                for (var i = 0; i < 5; i++){
                    if (classxpsleft[i] > 0){
                        allnegative = false;
                    }
                }
                if (allnegative){
                    break;
                }

                
                var maxval = -1;
                var maxindex = -1;
                //get which class is currently lowest
                for (var i = 0; i < 5; i++){
                    if (classxpsleft[i] > maxval) {
                        maxval = classxpsleft[i];
                        maxindex = i;
                    }
                }

                for (var i = 0; i < 5; i++){
                    if (i == maxindex){
                        classxpsleft[i] -= classperrun;
                        runstoca50[i] += 1;
                    } else {
                        classxpsleft[i] -= (classperrun/4);
                    }
                }
                
                
                
            }

            
            
            console.log("Runs to CA 50: " + runstoca50);
            var total = 0;
            for (var i = 0; i < 5; i++){
                var runs = runstoca50[i];
                runs = runs.toLocaleString();
                document.getElementById(classesabbrev[i] + "runs").innerText = runs;
                total += runstoca50[i];
            }
            if (total != 0){
                document.getElementById("totalruns").innerText = total.toLocaleString();
                copyabletext = "[adjectils] It will take " + total.toLocaleString() + " " + selectedfloor.options[selectedfloor.selectedIndex].text + " runs for " + name + " to reach Class Average 50 (" + runstoca50[0].toLocaleString() + " Archer, " + runstoca50[1].toLocaleString() + " Berserk, "  + runstoca50[2].toLocaleString() + " Healer, " + runstoca50[3].toLocaleString() + " Mage, " + runstoca50[4].toLocaleString() + " Tank)";
            } else {
                document.getElementById("totalruns").innerText = "0, gg :)";
                copyabletext = "[adjectils] " + name + " is Class Average 50, gg :)";
            }
            
            
        //} catch (TypeError){ 
            //console.log("Type error...");
            //document.getElementById("otherstatus").innerText = "This profile has no Dungeons stats!";
        //}
        
    }
    function copyText(){
        if (copyabletext != ""){
            const textarea = document.createElement("textarea");
            textarea.value = copyabletext;
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(textarea.value);
        }
    }
  </script>