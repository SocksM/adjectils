<!DOCTYPE html>
  <html lang = "en">
  <head>
    <meta name = "description" content = "Adjectils' Home Page!">
    <meta name = "author" content = "adjective_n0un">
    <meta name="viewport" content="width=device-width, initial-scale=0.5">
    <title>adjectils - Home</title>
    <link rel="stylesheet" href="stylesheet.css">
  
    <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
    <link rel="manifest" href="./favicon/site.webmanifest">
    <script src = "timeToMinutes.js"></script>
  </head>
  <body onload="updatePage()">
  
  <script type="text/javascript" src="/jquery-3.6.3.min.js"></script>
      <script>
      $(function(){
        $("#nav").load("nav.html"); 
      });
      </script>
  
  <div id = header style = "text-align: center; margin: 20px">
  <a href = "index.html" class = adjheader>adjectils</a><span class = header>&nbsp;|&nbsp;</span><span class = header>Home</span><br>
  <span class = "splash" id = "splashtext"></span>
  </div>
  <section class = "flex_box_index">
    <div class = "flex_index_row" style = "width:95%;height:50%; align-items: stretch;">
      <div class = "flex_index_box" style = "width: 64%" id = "election">
        <div style = "flex-basis: 100%">
          <span class = "indexheader">Current mayor:&nbsp;</span><span class = "indexheader" id = "currentmayor"></span><br>
        </div>
        <table id = "electiontable">

        </table>
      </div>
      <div class = "flex_index_box" style = "width: 34%; flex:1" id = "datetime">
        <div style = "display:flex; flex-basis:100%; justify-content:flex-end;">
          <span class = "indexheader" id = "sbmonth"></span><span class = "indexheader">&nbsp;</span><span class = "indexheader" id = "sbseason"></span><span class = "indexheader">&nbsp;</span><span class = "indexheader" id = "sbdate"></span>
        </div>
        <div style = "display:flex; flex-basis:100%; justify-content:flex-end;">
          <span style = "font-size: 20px;">Year&nbsp;</span><span style = "font-size:20px" id = sbyear></span>
        </div>
        <div style = "display:flex;flex-basis:100%; justify-content:flex-end;">
          <span id = "sbtime"></span>
        </div>
        <div style = "display:flex; flex-basis:100%; height:70%"></div>
      </div>
    </div>
    <div class = "flex_index_row" style = "width:95%; height:20%;">
    <div class = "flex_index_box" style = "width: 100%; height:70%;" id = "">
      <div style = "display:flex;flex-basis:100%;">
        <span class = header>Events</span>
      </div>
      <div style = "display:flex;flex-basis: min(calc(100% - 30px), max(600px, 65%));">
      <span style = "margin-right:20px">Notify me when events start</span>
      <div>

        <label class = "switchbox">
          <input type = "checkbox"  id = "notify" onchange = toggleEventNotif()>
          <span class = "switch"></span></label>
      </div>
      <div>
      </div>
      </div>
      <div class = "flex_full_row">
        <span id = "notifstatus">(Notifications disabled)</span>
      </div>
      <div class = "flex_full_row">
        <div>
          <form action = "#" id = "notificationtime">
            <label for = "notificationtime">Notify me
            <select id = "notibefore">
              <option value = 60>1</option>
              <option value = 180>3</option>
              <option value = 300>5</option>
              <option value = 600>10</option>
              <option value = 900>15</option>
              <option value = 1200>20</option>
              <option value = 1800>30</option>
              <option value = 2700>45</option>
              <option value = 3600>60</option>
            </select>
            minutes before event.</label>
          </form>
        </div>
      </div>
      <table id = "eventtable" style = "flex-basis: min(calc(100% - 30px), max(600px, 65%));">  
        
      </table>
    </div>
    </div>
    <div class = "flex_index_row" style = "width:95%; height:20%;">
    <div class = "flex_index_box" style = "width: 100%; height:70%;" id = "">
      <span class = header style = "flex-basis:100%">Election</span>
      <table id = "electiontable2">

      </table>
    </div>
    </div>
  </div>
</section>
<br>
  <div id = "nav" style = "width:min(83.3%, 600px); margin: auto;" class = "hub_block"></div>
  </body>
  <script>
    var date = new Date();
    var timeofday = "morning";
    if (date.getHours() < 5 && date.getHours() > -1){
      timeofday = "night";
    }
    if (date.getHours() < 20 && date.getHours() > 12){
      timeofday = "afternoon";
    }
    if (date.getHours() < 24 && date.getHours() > 19){
      timeofday = "evening";
    }
    console.log(timeofday);
    console.log(date.getHours());
    var splashes_morning = ["Since 2024!", "BrookeAFK helped a lot!", "Also play Warlords!", "Distributing binomials!", "Also visit nadeshiko.io!", "Stalking the API!", "NOT playing Skywars!", "Now with 100% more bugs!", "<o/", "Glad you made it!", "0.02% less sugar!", "Entertaining splash texts!", "Coming soon!", "Rise and shine!", "Wait up!", "Finally awake?", "Destiny awaits!", "What do you want to be?", "Greatness begins here!", "Planned everything out?", "Stay alert!", "The early runner gets the loot!", "Wake-up call!", "Another day!"];
    var splashes_afternoon = ["Great weather today!", "Overkill!", "BrookeAFK helped a lot!", "Just add water!", "Alpha tested!", "Admin endorsed!", "About 99% truthful!", "Ok, but when do we get the wave text?", "Not contradictory!", "Side effects include being awesome!", "May cause headaches!", "Ad-free!", "Life-changing!", "Optimized!", "How about a break?", "Meant to be!", "Best of three?", "Heart and soul!", "Reason enough!", "Sudden!", "https://adjectiven0un.github.io/holeinthewall ?", "Tap here to do absolutely nothing!", "Geronimo!", "Until we see the end of time!", "High intensity discharge!"];
    var splashes_evening = ["Better call Paul!", "BrookeAFK helped a lot!", "Can we make that a splash?", "Toasting marshmallows!", "Are we there yet?", "Were you there?", "Welcome back!", "Keep calm!", "Not scary!", "Regenerative!", "Treats boredom!", "Brevity!", "Written in notepad!", "Best viewed by candlelight!", "Hello, world?", "Traversing the Ratacombs!", "Foraging when?", "Cross my heart and hope to die!", "Watch your step!", "Full of secrets!", "Let me know how the sunset was!", "But if you close your eyes...", "Your biggest fan!", "Pit reference!", "Falling again!"];
    var splashes_night = ["Time for bed, perhaps?", "BrookeAFK helped a lot!", "Burning the midnight oil!", "The stars don't shine as bright as you!", "And don't be afraid of the dark!", "Don't do hacks!", "Full of easter eggs!", "Satiable hunger!", "Suitable for all ages!", "Updated in 3-5 business days!", "Now in dark theme!", "How many of these are there?", "Three's a crowd!", "Two nights until the Coven have the Necronomicon!", "Watch the doors!", "Once upon a midnight dreary...", "NIGHT QUEST! Kill 50 players!", "Tranquil, isn't it?", "No holding back!", "A push in the right direction!", "It was here all along!", "Toil and trouble!", "A light in the sky!", "Time after time!", "Ready, aim, fire!"];
    const daylen = 1200;
    const monthlen = 31 * daylen;
    const seasonlen = 3 * monthlen;
    const yearlen = 4 * seasonlen;
    const tenstep = daylen / (6 * 24);
    const seasons = ["Spring", "Summer", "Autumn", "Winter"];
    const monthlist = ["Early", "", "Late"];
    var initial = 1560275700;
    var currenttime = Date.now() / 1000;
    var yearcycletime = (currenttime - initial) % yearlen;
    var eventNotifs = 0;
    var notifPerms = 0;
    function toggleEventNotif(){
      eventNotifs = Math.abs(eventNotifs - 1);
      if (eventNotifs == 1){
        Notification.requestPermission().then(
        function(permission){
          if (permission == "granted"){
            console.log("Notifications enabled");
            document.getElementById("notifstatus").innerText = "(Notifications enabled)";
            notifPerms = 1;
          } else if (permission == "denied"){
            console.log("Notification permissions denied");
            document.getElementById("notifstatus").innerText = "(Notification access denied! Please enable notifications)";
          } else {
            console.log("Notifications not supported");
            document.getElementById("notifstatus").innerText = "(Your browser does not support notifications)";
          }
        }
        );
      } else {
        console.log("Notifications disabled");
        document.getElementById("notifstatus").innerText = "(Notifications disabled)";
      }
      
    }
    async function updatePage(){
        var splashindex = Math.floor(25 * Math.random());
        console.log("Chose splash " + splashindex);
        document.getElementById("splashtext").innerText = eval("splashes_" + timeofday)[splashindex];
        updateDate();
        updateEvents();
        setInterval(updateDate, 4167);
        setInterval(updateEvents, 1000);
        try {
          const apicall = await fetch("https://api.hypixel.net/resources/skyblock/election");
          if (!apicall.ok){
            console.log("Api call error");
            //document.getElementById("status").innerHTML = "<span class = errored>API error - come back later</span>";
            return -1;
          }
          const mayordata = await apicall.json();
          var currentmayor = mayordata.mayor.name;
          document.getElementById("currentmayor").innerText = currentmayor;
          for (var i = 0; i < mayordata.mayor.perks.length; i++){
            var perk = document.createElement("span");
            perk.textContent = mayordata.mayor.perks[i].name + ": " + mayordata.mayor.perks[i].description.replace(/ยง./g, "") + "\n";
            perk.style.display = "flex";
            perk.style.flexBasis = "100%";
            var electiontd = document.createElement("td");
            electiontd.appendChild(perk);
            var electiontr = document.createElement("tr");
            electiontr.style.display = "flex";
            electiontr.style.flexBasis = "100%";
            electiontr.appendChild(electiontd);
            electiontable.appendChild(electiontr);
          }
          
          
        } catch (NetworkError){
          document.getElementById("currentmayor").innerText = "Couldn't connect to API!";
          console.log("Couldn't find the current mayor! Is the API down?");
        }
        try {
          var timer = document.createElement("div");
          timer.style.display = "flex";
          timer.style.flexBasis = "100%";
          var text = document.createElement("span");
        } catch (Error) {
          console.log("Error making timer...");
        }
        try {
          const apicall = await fetch("https://api.hypixel.net/resources/skyblock/election");
          if (!apicall.ok){
            console.log("Api call error");
            //document.getElementById("status").innerHTML = "<span class = errored>API error - come back later</span>";
            return -1;
          }
          const mayordata = await apicall.json();
          const curdata = mayordata.current;
          var mayornames = ["", "", "", "", ""];
          var votes = ["", "", "", "", ""];
          var indexswaps = ["0", "1", "2", "3", "4"];
          for (var i = 0; i < 5; i++){
            mayornames[i] = curdata.candidates[i].name;
            votes[i] = curdata.candidates[i].votes;
          }
          console.log(votes);
          console.log(mayornames);
          for (var i = 1; i < 5; i++){
             var key1 = votes[i];
             var key2 = mayornames[i];
             var key3 = indexswaps[i];
             var j = i - 1;
             while (j >= 0 && votes[j] < key1){
              votes[j + 1] = votes[j];
              mayornames[j + 1] = mayornames[j];
              indexswaps[j + 1] = indexswaps[j];
              j--;
             }
             votes[j + 1] = key1;
             mayornames[j + 1] = key2;
             indexswaps[j + 1] = key3;
          }
          var votespercent = ["", "", "", "", ""];
          var votestotal = 0;
          for (var i = 0; i < 5; i++){
            votestotal += votes[i];
          }
          for (var i = 0; i < 5; i++){
            votespercent[i] = (100 * (votes[i] / votestotal)).toFixed(1);
          }
          for (var i = 0; i < 5; i++){
            console.log("Starting process...");
            var mayorrow1 = document.createElement("table");
            mayorrow1.style.width = "60%";
            var mayorname = document.createElement("td");
            mayorname.style.fontSize = "20px";
            mayorname.innerText = mayornames[i];
            mayorname.style.width = "15%";
            mayorrow1.style.borderBottom = "2px solid #c0c0c0";
            mayorrow1.style.marginTop = "2%";
            mayorrow1.appendChild(mayorname);
            var mayorvotes = document.createElement("td");
            mayorvotes.style.fontSize = "20px";
            mayorvotes.innerText = votes[i].toLocaleString() + " votes ";
            mayorvotes.style.width = "20%";
            mayorvotes.style.textAlign = "right";
            mayorrow1.appendChild(mayorvotes);
            var mayorpercent = document.createElement("td");
            mayorpercent.style.fontSize = "20px";
            mayorpercent.innerText = votespercent[i] + "%";
            mayorpercent.style.width = "20%";
            mayorpercent.style.textAlign = "right";
            mayorrow1.appendChild(mayorpercent);
            var mayorperktable = document.createElement("table");
            mayorperktable.style.width = "90%";
            for (var j = 0; j < curdata.candidates[indexswaps[i]].perks.length; j++){
              var perkrow1 = document.createElement("tr");
              perkrow1.style.width = "90%";
              var perktd1 = document.createElement("td");
              perktd1.style.width = "25%";
              var perktd2 = document.createElement("td");
              perktd1.innerText = curdata.candidates[indexswaps[i]].perks[j].name;
              perktd2.innerText = curdata.candidates[indexswaps[i]].perks[j].description.replace(/ยง./g, "") + "\n";
              perkrow1.appendChild(perktd1);
              perkrow1.appendChild(perktd2);
              mayorperktable.appendChild(perkrow1);
            }
            electiontable2.appendChild(mayorrow1);
            var mayorrow2 = document.createElement("tr");
            var mayortd2 = document.createElement("td");
            mayortd2.appendChild(mayorperktable);
            mayorrow2.appendChild(mayortd2);
            electiontable2.appendChild(mayorrow2);
            
          }
          
        } catch (TypeError){
          console.log("Mayor election is not on right now");
          var mayorrow = document.createElement("tr");
          var mayortd = document.createElement("td");
          var mayorname= document.createElement("div");
          mayorname.style.fontSize = "16px";
          mayorname.style.flexBasis = "100%";
          mayorname.innerText = "The election booth is closed right now. Come back later!";
          mayortd.appendChild(mayorname);
          mayorrow.appendChild(mayortd);
          electiontable2.appendChild(mayorrow);
        }
        
    }
    function updateDate(){
        currenttime = Math.floor(Date.now() / 1000);
        var year = Math.floor((currenttime - initial) / yearlen);
        document.getElementById("sbyear").innerText = year + 1;
        var yearcycletime = (currenttime - initial) % yearlen;
        var season = seasons[Math.floor(yearcycletime / seasonlen)];
        document.getElementById("sbseason").innerText = season;
        var seasoncycletime = (yearcycletime) % seasonlen;
        var month = monthlist[Math.floor(seasoncycletime / monthlen)];
        document.getElementById("sbmonth").innerText = month;
        var monthcycletime = (seasoncycletime) % monthlen;
        var day = Math.floor(monthcycletime / daylen);
        document.getElementById("sbdate").innerText = day + 1;
        var daycycletime = (monthcycletime) % daylen;
        var segments = Math.floor(daycycletime / tenstep);
        var minutes = segments % 6 + "0";
        var hours = Math.floor(segments / 6);
        var ampm = "am";
        if (hours > 12){
          hours -= 12;
          ampm = "pm";
        }
        document.getElementById("sbtime").innerText = hours + ":" + minutes + ampm;
    }
    var eventColors = {
        "hoppity": "#c64fbd",
        "electionClose": "#55ffff",
        "zoo1": "#55ff55",
        "electionOpen": "#55ffff",
        "spooky": "#ffaa00",
        "zoo2": "#55ff55",
        "winter": "#ff5555",
        "jerry": "#ff0000",
        "newyear": "#ff55ff",
    }
    var eventNames = {
        "hoppity": "Hoppity's Hunt",
        "electionClose": "Election finalized",
        "zoo1": "Traveling Zoo #1",
        "electionOpen": "Election starts",
        "spooky": "Spooky Festival",
        "zoo2": "Traveling Zoo #2",
        "winter": "Winter Island",
        "jerry": "Season of Jerry",
        "newyear": "New Year Celebration",
    }
    var previndex = -1;
    function updateEvents(){
      var initial = 1560275700;
      var now = Math.floor(Date.now() / 1000);
      var yearcycletime = (now - initial) % yearlen;
      var indices = ["hoppity", "electionClose", "zoo1", "electionOpen",  "spooky", "zoo2", "winter", "jerry", "newyear"];
      var timeUntil = {
        "hoppity": yearlen - yearcycletime,
        "electionClose": (yearlen + (2 * monthlen + 26 * daylen) - yearcycletime) % yearlen,
        "zoo1": (yearlen + (seasonlen) - yearcycletime) % yearlen,
        "electionOpen": (yearlen + (5 * monthlen + 26 * daylen) - yearcycletime) % yearlen,
        "spooky": (yearlen + (7 * monthlen + 28 * daylen) - yearcycletime) % yearlen,
        "zoo2": (yearlen + (3 * seasonlen) - yearcycletime) % yearlen, 
        "winter": (yearlen + (3 * seasonlen + 2 * monthlen) - yearcycletime) % yearlen,
        "jerry": (yearlen + (3 * seasonlen + 2 * monthlen + 23 * daylen) - yearcycletime) % yearlen,
        "newyear": (yearlen + (3 * seasonlen + 2 * monthlen + 28 * daylen) - yearcycletime) % yearlen,
    }
      var startindex;
      for (var i = 0; i < 9; i++){
        if (timeUntil[indices[i]] > timeUntil[indices[(i + 1) % 9]]){
          startindex = (i + 1) % 9;
        }
      }
      if (startindex != previndex){
        previndex = startindex;
        for (var i = startindex; i < startindex + 9; i++){
          if (document.getElementById(indices[(i) % 9] + "row") != undefined){
            eventtable.removeChild(document.getElementById(indices[i % 9] + "row"));
          }
          var row = document.createElement("tr");
          row.id = indices[i % 9] + "row";
          row.style.justifyContent = "space-evenly";
          row.style.width = "80%";
          var data1 = document.createElement("td");
          var namediv = document.createElement("div");
          
          namediv.style.display = "flex";
          namediv.style.flexBasis = "100%";
          namediv.style.width = "100%";
          var evname = document.createElement("span");
          evname.style = "color: " + eventColors[indices[i % 9]];
          evname.textContent = eventNames[indices[i % 9]] + ":";
          namediv.appendChild(evname);
          data1.appendChild(namediv);
          row.appendChild(data1);
          
          var data2 = document.createElement("td");
          var timediv = document.createElement("div");
          timediv.style.display = "flex";
          timediv.style.flexBasis = "100%";
          timediv.style.justifyContent = "flex-end";
          timediv.style.paddingRight = "10%";
          var evtime = document.createElement("span");
          evtime.textContent = "e";
          evtime.id = indices[i % 9] + "time";
          timediv.appendChild(evtime);
          data2.appendChild(timediv);
          row.appendChild(data2);
          var spacedata2 = document.createElement("td");
          var spacediv2 = document.createElement("div");
          
          var data3 = document.createElement("td");
          var datediv = document.createElement("div");
          datediv.style.display = "flex";
          datediv.style.flexBasis = "100%";
          datediv.style.justifyContent = "flex-end";
          var datespan = document.createElement("span");
          datespan.textContent = "e";
          datespan.id = indices[i % 9] + "date";
          datediv.appendChild(datespan);
          data3.appendChild(datediv);
          row.appendChild(data3);
          eventtable.appendChild(row);
        }
      }
      setEventTimer("hoppity", timeUntil["hoppity"], seasonlen);
      setEventTimer("electionOpen", timeUntil["electionOpen"], 0);
      setEventTimer("electionClose", timeUntil["electionClose"], 0);
      setEventTimer("spooky", timeUntil["spooky"], 3 * daylen);
      setEventTimer("winter", timeUntil["winter"], monthlen);
      setEventTimer("jerry", timeUntil["jerry"], 3 * daylen);
      setEventTimer("newyear", timeUntil["newyear"], 3 * daylen);
      setEventTimer("zoo1", timeUntil["zoo1"], 3 * daylen);
      setEventTimer("zoo2", timeUntil["zoo2"], 3 * daylen);
    }
    function setEventTimer(elementname, timer, eventDuration){
      if (timer > yearlen - eventDuration){
        document.getElementById(elementname + "time").innerText = "Active for " + timeToMinutes(timer - (yearlen - eventDuration));
        var current = Math.floor(Date.now() / 1000);
        var endtime = Math.floor(current - yearlen + timer + eventDuration);
        document.getElementById(elementname + "date").innerText = "Until " + convertTimestamp(endtime);
      } else {
        document.getElementById(elementname + "time").innerText = timeToMinutes(timer);
        var current = Math.floor(Date.now() / 1000);
        var eventtime = Math.floor(current + timer);
        document.getElementById(elementname + "date").innerText = "@ " + convertTimestamp(eventtime);
        if (timer == notibefore.value && eventNotifs == 1 && notifPerms == 1){
          var mingrammar = "minutes";
          if (notibefore.value == 60){
            mingrammar = "minute";
          }
          var notification = new Notification("adjectils", {body: eventNames[elementname] + " begins in " + Math.floor(notibefore.value/60) + " " + mingrammar, icon: "./favicon/favicon.ico"});
        }
      }
    }
</script>