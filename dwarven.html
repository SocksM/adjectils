<!DOCTYPE html>
  <html>
  <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
  <body onload="">
  <title>adjectils - Dwarven Mines</title>
  <link rel="stylesheet" href="stylesheet.css">
  <meta name = "description" content = "Dwarven utilities for Hypixel Skyblock">
  <meta name = "author" content = "adjective_n0un">
  <script type="text/javascript" src="/jquery-3.6.3.min.js"></script>
      <script>
      $(function(){
        $("#nav").load("nav.html"); 
      });
      </script>
  <span class = adjheader>adjectils</span><span class = header>&nbsp;|&nbsp;</span><span class = minesheader>Dwarven Mines</span><br>
  <input type = "text" onchange = updateForges(value)><br>
  <span id = "status">Enter a username to continue.</span><br>
  <div class = "dwarven_block" style = "width:800px">
    <span class = minesheader>Forge timers</span><br><br>
    <span class = errored>THIS WIDGET IS INCOMPLETE! Come back later...</span><br>
    <div id = "item1">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img style = "width:40px; height:40px" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span style = "font-size:18px">Slot 1: </span><span id = "forgeitem_1" style = "font-size:16px">Loading...</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter1>||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter>]</span>
      </div>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Expected completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time1>Loading...</span><br>
        <span id = finish1>Loading...</span>
      </div>
    </div>
    <div id = "item2">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img style = "width:40px; height:40px" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span style = "font-size:18px">Slot 2: </span><span id = "forgeitem_2" style = "font-size:16px">Loading...</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter1>||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter>]</span>
      </div>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Expected completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time2>Loading...</span><br>
        <span id = finish2>Loading...</span>
      </div>
    </div>
    <div id = "item3">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img style = "width:40px; height:40px" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span style = "font-size:18px">Slot 3: </span><span id = "forgeitem_3" style = "font-size:16px">Loading...</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter3>||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter>]</span>
      </div>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Expected completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time3>Loading...</span><br>
        <span id = finish3>Loading...</span>
      </div>
    </div>
    <div id = "item4">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img style = "width:40px; height:40px" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span style = "font-size:18px">Slot 4: </span><span id = "forgeitem_4" style = "font-size:16px">Loading...</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter4>||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter>]</span>
      </div>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Expected completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time4>Loading...</span><br>
        <span id = finish4>Loading...</span>
      </div>
    </div>
    <div id = "item5">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img style = "width:40px; height:40px" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span style = "font-size:18px">Slot 5: </span><span id = "forgeitem_5" style = "font-size:16px">Loading...</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter5>||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter>]</span>
      </div>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Expected completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time5>Loading...</span><br>
        <span id = finish5>Loading...</span>
      </div>
    </div>
      
  </div>
  
  <div id = "nav" class = "dwarven_block" style = "width:600px"></div>
  </body>
  <script src = "getUUID.js"></script>
  <script>
    var translations = {
      //todo: finish this
      "REFINED_DIAMOND": "Refined Diamond",
      "REFINED_MITHRIL": "Refined Mithril",
      "REFINED_TITANIUM": "Refined Titanium",
      "FUEL_TANK": "Fuel Tank",
      "BEJEWELED_HANDLE": "Bejeweled Handle",
      "BEJEWELED_COLLAR": "Bejeweled Collar",
      "DRILL_ENGINE": "Drill Engine",
      "GOLDEN_PLATE": "Golden Plate",
      "MITHRIL_PLATE": "Mithril Plate",
      "GEMSTONE_MIXTURE": "Gemstone Mixture",

    }
    var times = {
      "REFINED_DIAMOND": 28800,
      "REFINED_MITHRIL": 21600,
      "REFINED_TITANIUM": 43200,
      "FUEL_TANK": 36000,
      "BEJEWELED_HANDLE": 1800,
      "BEJEWELED_COLLAR": 7200,
      "DRILL_ENGINE": 108000,
      "GOLDEN_PLATE": 21600,
      "MITHRIL_PLATE": 64800,
      "GEMSTONE_MIXTURE": 14400,
    }
    var quickforgetimes = {
      0: 1,
      1: 0.895,
      2: 0.89,
      3: 0.885,
      4: 0.88,
      5: 0.875,
      6: 0.87,
      7: 0.865,
      8: 0.86,
      9: 0.855,
      10: 0.85,
      11: 0.845,
      12: 0.84,
      13: 0.835,
      14: 0.83,
      15: 0.825,
      16: 0.82,
      17: 0.815,
      18: 0.81,
      19: 0.805,
      //WHY DOES IT WORK LIKE THIS????? I DON'T FUCKING KNOW
      20: 0.7,
    }
    const intervalID = [];
    async function updateForges(name){
      clearInterval(intervalID[0]);
      intervalID.length = 0;
      var UUID = await getUUIDbyName(name);
      //try {
        const apicall = await fetch("https://api.hypixel.net/skyblock/profiles?key=" + key + "&uuid=" + UUID);
        if (!apicall.ok){
          console.log("Api call error");
        }
        const data = await apicall.json();
        var forgelog;
        try {
          forgelog = (data.profiles[data.profiles.length - 1].members[UUID].forge.forge_processes.forge_1);
        } catch (TypeError){
          console.log("No active forges");
          forgelog = "Empty";
        }
        var quickforge;
        try {
          quickforge = (data.profiles[data.profiles.length - 1].members[UUID].mining_core.nodes.forge_time);
        } catch (TypeError){
          quickforge = 0;
        }
        var qfm = quickforgetimes[quickforge];
        console.log("Quick forge multiplier: " + qfm);
        for (var i = 1; i <= 5; i++){
          try {
            if (forgelog[i].id != undefined){
              document.getElementById("forgeitem_" + i).innerText = translations[forgelog[i].id];
            } else {
              
              document.getElementById("forgeitem_" + i).innerText = "None";
              
            }
          }
          catch (TypeError) {
            document.getElementById("forgeitem_" + i).innerText = "None";
          }
          
        }
        var interval = setInterval(() => updateTimers(qfm, forgelog), 1000);
        intervalID.push(interval);
      
    }

    async function updateTimers(qfm, forgelog){
      var actives = [1, 1, 1, 1, 1];
      console.log("Started update");
      if (forgelog == "Empty"){
        console.log("No items found");
        clearInterval(intervalID[0]);
        intervalID.length = 0;
      } else {
        for (var i = 1; i <= 5; i++){
          try {
            var timeelapsed = ((Date.now() - forgelog[i].startTime)/1000);
            var maxtime = qfm * times[forgelog[i].id];
            var timeremaining = (maxtime - timeelapsed).toFixed(0);
            if (timeremaining <= 0){
              timeremaining = 0;
            }
            console.log("Time remaining for item " + i + " is " + timeremaining + " seconds");
            if (timeremaining == 0){
              actives[i - 1] = 0;
            }
            
          } catch (TypeError) {
            console.log("No item in slot " + i);
            actives[i - 1] = 0;
          }
        }
        
      }
      if (actives[0] == 0 && actives[1] == 0 && actives[2] == 0 && actives[3] == 0 && actives[4] == 0){
        console.log("All items complete");
        clearInterval(intervalID[0]);
        intervalID.length = 0;
      }
    }
  </script>
  </html>
  