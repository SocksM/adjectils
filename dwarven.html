<!DOCTYPE html>
  <html lang = "en">
    <head>
      <title>adjectils - Dwarven Mines</title>
      <link rel="stylesheet" href="stylesheet.css">
      <meta name = "description" content = "Dwarven utilities for Hypixel SkyBlock">
      <meta name = "author" content = "adjective_n0un">
      <meta name = "viewport" content="width=device-width, initial-scale=0.6">
      <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png">
      <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">
      <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
      <link rel="manifest" href="./favicon/site.webmanifest">
      <script type="text/javascript" src="/jquery-3.6.3.min.js"></script>
      <script src = "getUUID.js"></script>
      <script src = "timeToMinutes.js"></script>
      <script src = "dwarvendata.js"></script>
    </head>
  <body onload="updatePage()" style = "background-image:url(./images/dwarvenbg.png); background-size:15%">
  
      <script>
      $(function(){
        $("#nav").load("nav.html", function() { setWord(); }); 
      });
      </script>
  
  <div id = header class = "standardwidth" style = "text-align:center; background-color: #282828;">
    <a href = "index.html" class = adjheader>adjectils</a><span class = header>&nbsp;|&nbsp;</span><span class = minesheader>Dwarven Mines</span><br>
  </div>  
  <div class = "standardwidth" style = "text-align:center">
  <label style = "background-color:#282828">Username: <input type = "text" id = "nameinput" onchange = updateForges(value)>&nbsp;</label><button onclick = updateForges(nameinput.value) style = "width: 80px; height: 24px; text-align:center">Refresh ⟳</button><span>&nbsp;</span><span id = "refreshstatus"></span><br>
  <div>
  <span id = "status" style = "background-color: #282828;">Enter a username to continue.&nbsp;</span>
  </div>
  <br>
  <div>
    <form action = "#" style = "background-color: #282828;">
      <label>Profile:
      <select id = profileid value = 4 onchange = updateForges(nameinput.value)>
        <option id = profile0 value = 0>–––––</option>
        <option id = profile1 value = 1>–––––</option>
        <option id = profile2 value = 2>–––––</option>
        <option id = profile3 value = 3>–––––</option>
        <option id = profile4 value = 4>–––––</option>
      </select>
      </label>
    </form>
  </div>
  </div>
  <section class = "flex_box_index">
  <div class = "dwarven_block " style = "width:min(calc(100% - 30px), max(800px, 40%)); margin:auto">
    <span class = minesheader>Forge timers</span><br><br>
    <span class = basictext>Quick Forge level: </span><span class = basictext id = quickforgelevel>0</span><br><br>

    <div style = "display:flex;flex-basis: min(calc(100% - 30px), max(600px, 65%));">
      <span style = "margin-right:20px">Notify me when forges complete</span>
      <div>

        <label class = "switchbox" id = "notifyswitch" for = "notify">
          <input type = "checkbox"  id = "notify" onchange = toggleEventNotif() aria-labelledby = "notifyswitch">
          <span class = "switch"></span>
        </label>
      </div>
      <div>
      </div>
      </div>
      <div class = "flex_full_row">
        <span id = "notifstatus">(Notifications disabled)</span>
      </div>

    <div id = "item1" class = "flex_forge_box">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img id = "img1" style = "width:40px; height:40px; opacity:0" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px; margin-left:10px;">
        <span style = "font-size:18px">Slot 1: </span><span id = "forgeitem_1" style = "font-size:16px">None</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter1>||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter id = forgeunmeter1></span><span class = meter>]</span>
      </div>
      <div id = timers1>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time1>&ndash;&ndash;:&ndash;&ndash;</span><br>
        <span id = finish1>&ndash;&ndash;:&ndash;&ndash;</span>
      </div>
      </div>
    </div>
    <div id = "item2" class = "flex_forge_box">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img id = "img2" style = "width:40px; height:40px; opacity:0" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px; margin-left:10px;">
        <span style = "font-size:18px">Slot 2: </span><span id = "forgeitem_2" style = "font-size:16px">None</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter2>||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter id = forgeunmeter2></span><span class = meter>]</span>
      </div>
      <div id = timers2>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time2>&ndash;&ndash;:&ndash;&ndash;</span><br>
        <span id = finish2>&ndash;&ndash;:&ndash;&ndash;</span>
      </div>
      </div>
    </div>
    <div id = "item3" class = "flex_forge_box">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img id = "img3" style = "width:40px; height:40px; opacity:0" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px; margin-left:10px;">
        <span style = "font-size:18px">Slot 3: </span><span id = "forgeitem_3" style = "font-size:16px">None</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter3>||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter id = forgeunmeter3></span><span class = meter>]</span>
      </div>
      <div id = timers3>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time3>&ndash;&ndash;:&ndash;&ndash;</span><br>
        <span id = finish3>&ndash;&ndash;:&ndash;&ndash;</span>
      </div>
      </div>
    </div>
    <div id = "item4" class = "flex_forge_box">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img id = "img4" style = "width:40px; height:40px; opacity:0" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px; margin-left:10px;">
        <span style = "font-size:18px">Slot 4: </span><span id = "forgeitem_4" style = "font-size:16px">None</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter4>||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter id = forgeunmeter4></span><span class = meter>]</span>
      </div>
      <div id = timers4>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px;">
        <span id = time4>&ndash;&ndash;:&ndash;&ndash;</span><br>
        <span id = finish4>&ndash;&ndash;:&ndash;&ndash;</span>
      </div>
      </div>
    </div>
    <div id = "item5" class = "flex_forge_box"> 
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img id = "img5" style = "width:40px; height:40px; opacity:0" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px; margin-left:10px;">
        <span style = "font-size:18px">Slot 5: </span><span id = "forgeitem_5" style = "font-size:16px">None</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter5>||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter id = forgeunmeter5></span><span class = meter>]</span>
      </div>
      <div id = timers5>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time5>&ndash;&ndash;:&ndash;&ndash;</span><br>
        <span id = finish5>&ndash;&ndash;:&ndash;&ndash;</span>
      </div>
      </div>
    </div>
      
  </div>
  </section>
  <div id = "nav" class = "dwarven_block standardwidth"></div>
  </body>
  <script>
    var fasttrack = false;
    var data;
    async function updatePage(){
      updateSizes();
        console.log("Stored a name: " + localStorage.getItem("storedname"));
        if (localStorage.getItem("storedname") != null){
            console.log("Found a previous name and data! Loading...");
            console.log("Previous name: " + localStorage.getItem("storedname"));
            console.log("Previous data: " + localStorage.getItem("storeddata"));
            document.getElementById("nameinput").value = localStorage.getItem("storedname");
            data = JSON.parse(localStorage.getItem("storeddata"));
            fasttrack = true;
            updateForges(localStorage.getItem("storedname"));
        }
    }
    const intervalID = [];
    var onCD = false;
    var eventNotifs = 0;
    var notifPerms = 0;
    
    function fullReset(){
      for (var i = 1; i <= 5; i++){
            document.getElementById("time" + i).innerText = "––:––";
            document.getElementById("finish" + i).innerText = "––:––";
            document.getElementById("forgeunmeter" + i).innerText = "";
            document.getElementById("forgemeter" + i).style.color = "#c0c0c0";
            document.getElementById("forgemeter" + i).innerText = "||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||";
            document.getElementById("img" + i).style.opacity = 0;
            document.getElementById("img" + i).src = "./images/filler.png";
          }
          console.log("No active forges");
          
    }
    var lastname = "";
    
    async function updateForges(name){
      fullReset();
      if (onCD == true){
        document.getElementById("refreshstatus").innerText = "Please wait 5 seconds before using this again.";
        console.log("On cooldown!");
        return -1;
      } else {
        document.getElementById("refreshstatus").innerText = "";
        if (!fasttrack){
            onCD = true;
            setTimeout(() => { onCD = false }, 5000);
        }
      }
      var UUID = await getUUIDbyName(name);
      if (UUID == -1) {
        return -1;
      }
      if (!fasttrack){
        data = await getAPIdata(UUID);
      }
      fasttrack = false;
      if (data.profiles == null) {
        document.getElementById("status").innerText = "This player hasn't played on Hypixel!"
        return -1;
      }
      if (lastname != name){

      
      
      clearInterval(intervalID[0]);
      intervalID.length = 0;
      
      //try {
        
        
        var profilelist;
        try {
          profilelist = (data.profiles);
          for (var i = 0; i < 5; i++){
            document.getElementById("profile" + i).innerText = "–––––";
          }
          for (var i = 0; i < profilelist.length; i++){
            document.getElementById("profile" + i).innerText = profilelist[i].cute_name;
          }
          if (lastname != name){
            var profilenum = 0;
            for (var i = 0; i < profilelist.length; i++){
              if (profilelist[i].selected){
                profilenum = i;
                console.log("Profile ID found: " + profilenum);
                
                break;
              }
            }
            document.getElementById("profileid").value = profilenum;
          }
        } catch (TypeError){
          fullReset();
        }
        lastname = name;
        
      }
        localStorage.setItem("storedname", name);
        localStorage.setItem("storeddata", JSON.stringify(data));
        var forgelog;
        try {
          forgelog = (data.profiles[profileid.value].members[UUID].forge.forge_processes.forge_1);
        } catch (TypeError){
          fullReset();
          forgelog = "Empty";
        }
        var quickforge;
        try {
          quickforge = (data.profiles[profileid.value].members[UUID].mining_core.nodes.forge_time);
        } catch (TypeError){
          quickforge = 0;
        }
        if (quickforge == undefined){
          quickforge = 0;
        }
        var qfm = quickforgetimes[quickforge];
        document.getElementById("quickforgelevel").innerText = quickforge;
        
        for (var i = 1; i <= 5; i++){
          try {
            if (forgelog[i].id != undefined){
              document.getElementById("forgeitem_" + i).innerText = translations[forgelog[i].id];
              console.log("Item ID: " + forgelog[i].id);
              document.getElementById("img" + i).src = "./images/forge_items/" + forgelog[i].id + ".png";
              document.getElementById("img" + i).style.opacity = 1;
            } else {
              
              document.getElementById("forgeitem_" + i).innerText = "None";
              
            }
          }
          catch (TypeError) {
            document.getElementById("forgeitem_" + i).innerText = "None";
          }
          
        }
        for (var i = 1; i <= 5; i++){
          try {
            if (forgelog[i].id != undefined){
              var maxtime = qfm * times[forgelog[i].id];
              var finaltime = new Date(forgelog[i].startTime + (maxtime*1000));
              document.getElementById("finish" + i).innerText = finaltime.getHours() + ":" + fixTime(finaltime.getMinutes()) + ":" + fixTime(finaltime.getSeconds()) + " – " + months[finaltime.getMonth()] + " " + finaltime.getDate();
            } else {
              document.getElementById("finish" + i).innerText = "––:––";
            }
            
          } catch (TypeError){
            document.getElementById("finish" + i).innerText = "––:––";
          }
          
        }
        var interval = setInterval(() => updateTimers(qfm, forgelog), 1000);
        intervalID.push(interval);
      
      
    }

    async function updateTimers(qfm, forgelog){
      var actives = [1, 1, 1, 1, 1];
      if (forgelog == "Empty"){
        for (var i = 1; i <= 5; i++){
          document.getElementById("time" + i).innerText = "––:––";
          document.getElementById("finish" + i).innerText = "––:––";
          document.getElementById("forgeunmeter" + i).innerText = "";
          document.getElementById("forgemeter" + i).style.color = "#c0c0c0";
          document.getElementById("forgemeter" + i).innerText = "||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||";
        }
        console.log("No items found");
        clearInterval(intervalID[0]);
        intervalID.length = 0;
      } else {
        for (var i = 1; i <= 5; i++){
          try {
            var timeelapsed = ((Date.now() - forgelog[i].startTime)/1000);
            var maxtime = qfm * times[forgelog[i].id];
            var dontnotify = false;
            if (timeelapsed > maxtime){
              //1 second buffer for consistency purposes
              if (timeelapsed - maxtime > 1) {
                dontnotify = true;
              }
              timeelapsed = maxtime;
            }
            var timeremaining = (maxtime - timeelapsed).toFixed(0);
            var ticks = ((timeelapsed / maxtime) * 60).toFixed(0);
            if (timeremaining < 0){
              timeremaining = 0;
            }
            else if (timeremaining == 0){
              actives[i - 1] = 0;
              document.getElementById("time" + i).innerText = "Finished!";
              
              //send notif here
              if (eventNotifs == 1 && notifPerms == 1 && dontnotify == false){
                  var notification = new Notification("adjectils", {body:  translations[forgelog[i].id] + " forge process complete", icon: "./favicon/favicon.ico"});
              }
              

            } else {
              document.getElementById("time" + i).innerText = timeToMinutes(timeremaining);
            }
            
            var chunk1 = "";
            var chunk2 = "";
            for (var j = 0; j < ticks; j++){
              chunk1 = chunk1 + "|";
            }
            for (var j = ticks; j < 60; j++){
              chunk2 = chunk2 + "|";
            }
            var redhex = (60-ticks) * 4;
            var greenhex = (ticks) * 4;
            if (redhex == 0){
              redhex = "00";
            } else if (redhex < 16){
              redhex = "0" + redhex.toString(16);
            } else if (redhex % 16 == 0){
              redhex = redhex.toString(16);
            } else {
              redhex = redhex.toString(16);
            }
            
            if (greenhex == 0){
              greenhex = "00";
            } else if (greenhex < 16){
              greenhex = "0" + greenhex.toString(16);
            } else if (greenhex % 16 == 0){
              greenhex = greenhex.toString(16);
            } else {
              greenhex = greenhex.toString(16);
            }
            var hexcolor = "";
            hexcolor = "#" + redhex + greenhex + "00";
            document.getElementById("forgemeter" + i).style.color = hexcolor;
            document.getElementById("forgemeter" + i).innerText = chunk1;
            document.getElementById("forgeunmeter" + i).innerText = chunk2;
            
          } catch (TypeError) {
            actives[i - 1] = 0;
            document.getElementById("time" + i).innerText = "Inactive";
          }
        }
        
      }
      if (actives[0] == 0 && actives[1] == 0 && actives[2] == 0 && actives[3] == 0 && actives[4] == 0){
        console.log("All items complete");
        clearInterval(intervalID[0]);
        intervalID.length = 0;
      }
    }
    window.addEventListener('resize', updateSizes());
    function updateSizes(){
        console.log("Current width: " + window.innerWidth);
        if (window.innerWidth >= 768 * (5/3)) {
            console.log("Desktop mode...");
            for (var i = 1; i <= 5; i++){
                document.getElementById("timers" + i).style.flexBasis = "";
            }
      
        } else {
            console.log("Mobile mode...");
            for (var i = 1; i <= 5; i++){
                document.getElementById("timers" + i).style.flexBasis = "100%";
            }
      
        }
    }
    function toggleEventNotif(){
      eventNotifs = Math.abs(eventNotifs - 1);
      if (eventNotifs == 1){
        Notification.requestPermission().then(
        function(permission){
          if (permission == "granted"){
            console.log("Notifications enabled");
            document.getElementById("notifstatus").innerText = "(Notifications enabled)";
            notifPerms = 1;
          } else if (permission == "denied"){
            console.log("Notification permissions denied");
            document.getElementById("notifstatus").innerText = "(Notification access denied! Please enable notifications)";
          } else {
            console.log("Notifications not supported");
            document.getElementById("notifstatus").innerText = "(Your browser does not support notifications)";
          }
        }
        );
      } else {
        console.log("Notifications disabled");
        document.getElementById("notifstatus").innerText = "(Notifications disabled)";
      }
      
    }
  </script>
  </html>
  