<!DOCTYPE html>
  <html>
  <body onload="" style = "background-image:url(./images/dwarvenbg.png); background-size:15%">
  <title>adjectils - Dwarven Mines</title>
  <link rel="stylesheet" href="stylesheet.css">
  <meta name = "description" content = "Dwarven utilities for Hypixel SkyBlock">
  <meta name = "author" content = "adjective_n0un">
  <script type="text/javascript" src="/jquery-3.6.3.min.js"></script>
      <script>
      $(function(){
        $("#nav").load("nav.html"); 
      });
      </script>
  <div id = header style = "background-color: #282828; width: 340px">
    <a href = "index.html" class = adjheader>adjectils</a><span class = header>&nbsp;|&nbsp;</span><span class = minesheader>Dwarven Mines</span><br>
  </div>  
  <input type = "text" id = "nameinput" onchange = updateForges(value)><span>&nbsp;</span><button onclick = updateForges(nameinput.value) style = "width: 80px; height: 24px; text-align:center">Refresh ⟳</button><span>&nbsp;</span><span id = "refreshstatus"></span><br>
  <div style = "float:left; width:270px;">
  <span id = "status" style = "background-color: #282828;">Enter a username to continue.&nbsp;</span>
  </div>
  <br>
  <div style = "float:left;">
    <form action = "#" style = "background-color: #282828;">
      <label>Profile:</label>
      <select id = profileid value = 4 onchange = updateForges(nameinput.value)>
        <option id = profile0 value = 0>–––––</option>
        <option id = profile1 value = 1>–––––</option>
        <option id = profile2 value = 2>–––––</option>
        <option id = profile3 value = 3>–––––</option>
        <option id = profile4 value = 4>–––––</option>
      </select>
    </form>
  </div>
  <div style = "display: inline-block;">
    
  </div>
  <div class = "dwarven_block" style = "width:800px">
    <span class = minesheader>Forge timers</span><br><br>
    <span class = basictext>Quick Forge level: </span><span class = basictext id = quickforgelevel>0</span><br><br>
    <div id = "item1">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img id = "img1" style = "width:40px; height:40px; opacity:0" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px; margin-left:10px;">
        <span style = "font-size:18px">Slot 1: </span><span id = "forgeitem_1" style = "font-size:16px">None</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter1>||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter id = forgeunmeter1></span><span class = meter>]</span>
      </div>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time1>&ndash;&ndash;:&ndash;&ndash;</span><br>
        <span id = finish1>&ndash;&ndash;:&ndash;&ndash;</span>
      </div>
    </div>
    <div id = "item2">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img id = "img2" style = "width:40px; height:40px; opacity:0" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px; margin-left:10px;">
        <span style = "font-size:18px">Slot 2: </span><span id = "forgeitem_2" style = "font-size:16px">None</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter2>||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter id = forgeunmeter2></span><span class = meter>]</span>
      </div>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time2>&ndash;&ndash;:&ndash;&ndash;</span><br>
        <span id = finish2>&ndash;&ndash;:&ndash;&ndash;</span>
      </div>
    </div>
    <div id = "item3">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img id = "img3" style = "width:40px; height:40px; opacity:0" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px; margin-left:10px;">
        <span style = "font-size:18px">Slot 3: </span><span id = "forgeitem_3" style = "font-size:16px">None</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter3>||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter id = forgeunmeter3></span><span class = meter>]</span>
      </div>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time3>&ndash;&ndash;:&ndash;&ndash;</span><br>
        <span id = finish3>&ndash;&ndash;:&ndash;&ndash;</span>
      </div>
    </div>
    <div id = "item4">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img id = "img4" style = "width:40px; height:40px; opacity:0" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px; margin-left:10px;">
        <span style = "font-size:18px">Slot 4: </span><span id = "forgeitem_4" style = "font-size:16px">None</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter4>||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter id = forgeunmeter4></span><span class = meter>]</span>
      </div>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px;">
        <span id = time4>&ndash;&ndash;:&ndash;&ndash;</span><br>
        <span id = finish4>&ndash;&ndash;:&ndash;&ndash;</span>
      </div>
    </div>
    <div id = "item5">
      <div style = "float:left; width:40px; height:40px; margin:5px;">
        <img id = "img5" style = "width:40px; height:40px; opacity:0" src = "./images/filler.png">
      </div>
      <div style = "display:inline-block; margin:5px; height:40px; margin-left:10px;">
        <span style = "font-size:18px">Slot 5: </span><span id = "forgeitem_5" style = "font-size:16px">None</span><br>
        <span class = meter>[</span><span class = meter id = forgemeter5>||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||</span><span class = meter id = forgeunmeter5></span><span class = meter>]</span>
      </div>
      <div style = "display:inline-block; margin:5px; margin-left: 20px; height:40px">
        <span>&nbsp;Remaining time:&nbsp;</span><br>
        <span>&nbsp;Completion time:&nbsp;</span>
      </div>
      <div style = "display:inline-block; margin:5px; height:40px">
        <span id = time5>&ndash;&ndash;:&ndash;&ndash;</span><br>
        <span id = finish5>&ndash;&ndash;:&ndash;&ndash;</span>
      </div>
    </div>
      
  </div>
  
  <div id = "nav" class = "dwarven_block" style = "width:600px"></div>
  </body>
  <script src = "getUUID.js"></script>
  <script src = "timeToMinutes.js"></script>
  <script src = "dwarvendata.js"></script>
  <script>
    const intervalID = [];
    var onCD = false;
    function resetCD(){
      console.log("Attempted CD reset");
      onCD = false;
    }
    function fullReset(forgelog){
      for (var i = 1; i <= 5; i++){
            document.getElementById("time" + i).innerText = "––:––";
            document.getElementById("finish" + i).innerText = "––:––";
            document.getElementById("forgeunmeter" + i).innerText = "";
            document.getElementById("forgemeter" + i).style.color = "#c0c0c0";
            document.getElementById("forgemeter" + i).innerText = "||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||";
            document.getElementById("img" + i).style.opacity = 0;
            document.getElementById("img" + i).src = "./images/filler.png";
          }
          console.log("No active forges");
          
    }
    var lastname;
    async function updateForges(name){
      
      if (onCD == true){
        document.getElementById("refreshstatus").innerText = "Please wait 3 seconds before using this again.";
        console.log("On cooldown!");
        return -1;
      } else {
        document.getElementById("refreshstatus").innerText = "";
        onCD = true;
        setTimeout(() => { onCD = false }, 3000);
      }
      fullReset();
      clearInterval(intervalID[0]);
      intervalID.length = 0;
      var UUID = await getUUIDbyName(name);
      //try {
        const apicall = await fetch("https://api.hypixel.net/skyblock/profiles?key=" + key + "&uuid=" + UUID);
        if (!apicall.ok){
          console.log("Api call error");
          document.getElementById("status").innerHTML = "<span class = errored>API error - come back later</span>";
          return -1;
        }
        const data = await apicall.json();
        var profilelist;
        try {
          profilelist = (data.profiles);
          for (var i = 0; i < 5; i++){
            document.getElementById("profile" + i).innerText = "–––––";
          }
          for (var i = 0; i < profilelist.length; i++){
            document.getElementById("profile" + i).innerText = profilelist[i].cute_name;
          }
          if (lastname != name){
            document.getElementById("profileid").value = profilelist.length - 1;
            lastname = name;  
          }
        } catch (TypeError){
          fullReset();
        }
        var forgelog;
        try {
          forgelog = (data.profiles[profileid.value].members[UUID].forge.forge_processes.forge_1);
        } catch (TypeError){
          fullReset();
          forgelog = "Empty";
        }
        var quickforge;
        try {
          quickforge = (data.profiles[profileid.value].members[UUID].mining_core.nodes.forge_time);
        } catch (TypeError){
          quickforge = 0;
        }
        if (quickforge == undefined){
          quickforge = 0;
        }
        var qfm = quickforgetimes[quickforge];
        document.getElementById("quickforgelevel").innerText = quickforge;
        
        for (var i = 1; i <= 5; i++){
          try {
            if (forgelog[i].id != undefined){
              document.getElementById("forgeitem_" + i).innerText = translations[forgelog[i].id];
              console.log("Item ID: " + forgelog[i].id);
              document.getElementById("img" + i).src = "./images/" + forgelog[i].id + ".png";
              document.getElementById("img" + i).style.opacity = 1;
            } else {
              
              document.getElementById("forgeitem_" + i).innerText = "None";
              
            }
          }
          catch (TypeError) {
            document.getElementById("forgeitem_" + i).innerText = "None";
          }
          
        }
        for (var i = 1; i <= 5; i++){
          try {
            if (forgelog[i].id != undefined){
              var maxtime = qfm * times[forgelog[i].id];
              var finaltime = new Date(forgelog[i].startTime + (maxtime*1000));
              document.getElementById("finish" + i).innerText = finaltime.getHours() + ":" + fixTime(finaltime.getMinutes()) + ":" + fixTime(finaltime.getSeconds()) + " – " + months[finaltime.getMonth()] + finaltime.getDate();
            } else {
              document.getElementById("finish" + i).innerText = "––:––";
            }
            
          } catch (TypeError){
            document.getElementById("finish" + i).innerText = "––:––";
          }
          
        }
        var interval = setInterval(() => updateTimers(qfm, forgelog), 1000);
        intervalID.push(interval);
      
    }

    async function updateTimers(qfm, forgelog){
      var actives = [1, 1, 1, 1, 1];
      if (forgelog == "Empty"){
        for (var i = 1; i <= 5; i++){
          document.getElementById("time" + i).innerText = "––:––";
          document.getElementById("finish" + i).innerText = "––:––";
          document.getElementById("forgeunmeter" + i).innerText = "";
          document.getElementById("forgemeter" + i).style.color = "#c0c0c0";
          document.getElementById("forgemeter" + i).innerText = "||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||";
        }
        console.log("No items found");
        clearInterval(intervalID[0]);
        intervalID.length = 0;
      } else {
        for (var i = 1; i <= 5; i++){
          try {
            var timeelapsed = ((Date.now() - forgelog[i].startTime)/1000);
            var maxtime = qfm * times[forgelog[i].id];
            if (timeelapsed > maxtime){
              timeelapsed = maxtime;
            }
            var timeremaining = (maxtime - timeelapsed).toFixed(0);
            var ticks = ((timeelapsed / maxtime) * 60).toFixed(0);
            
            if (timeremaining <= 0){
              timeremaining = 0;
            }
            if (timeremaining == 0){
              actives[i - 1] = 0;
              document.getElementById("time" + i).innerText = "Finished!";
            } else {
              document.getElementById("time" + i).innerText = timeToMinutes(timeremaining);
            }
            
            var chunk1 = "";
            var chunk2 = "";
            for (var j = 0; j < ticks; j++){
              chunk1 = chunk1 + "|";
            }
            for (var j = ticks; j < 60; j++){
              chunk2 = chunk2 + "|";
            }
            var redhex = (60-ticks) * 4;
            var greenhex = (ticks) * 4;
            if (redhex == 0){
              redhex = "00";
            } else if (redhex < 16){
              redhex = "0" + redhex.toString(16);
            } else if (redhex % 16 == 0){
              redhex = redhex.toString(16);
            } else {
              redhex = redhex.toString(16);
            }
            
            if (greenhex == 0){
              greenhex = "00";
            } else if (greenhex < 16){
              greenhex = "0" + greenhex.toString(16);
            } else if (greenhex % 16 == 0){
              greenhex = greenhex.toString(16);
            } else {
              greenhex = greenhex.toString(16);
            }
            var hexcolor = "";
            hexcolor = "#" + redhex + greenhex + "00";
            document.getElementById("forgemeter" + i).style.color = hexcolor;
            document.getElementById("forgemeter" + i).innerText = chunk1;
            document.getElementById("forgeunmeter" + i).innerText = chunk2;
            
          } catch (TypeError) {
            console.log("No item in slot " + i);
            actives[i - 1] = 0;
            document.getElementById("time" + i).innerText = "Inactive";
          }
        }
        
      }
      if (actives[0] == 0 && actives[1] == 0 && actives[2] == 0 && actives[3] == 0 && actives[4] == 0){
        console.log("All items complete");
        clearInterval(intervalID[0]);
        intervalID.length = 0;
      }
    }
  </script>
  </html>
  