<!DOCTYPE html>
  <html lang = "en">
    <head>
      <title>adjectils - Harp</title>
      <link rel="stylesheet" href="stylesheet.css">
      <meta name = "description" content = "Melodic simulation for Hypixel SkyBlock">
      <meta name = "author" content = "adjective_n0un">
      <meta name = "viewport" content="width=device-width, initial-scale=0.6">
      <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png">
      <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">
      <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
      <link rel="manifest" href="./favicon/site.webmanifest">
      <script type="text/javascript" src="/jquery-3.6.3.min.js"></script>
    </head>
  <body onload="updatePage()">
  
      <script>
      $(function(){
        $("#nav").load("nav.html", function() { setWord(); }); 
      });
      </script>
  <div style = "text-align:center; margin: auto"> 
    <span class = adjheader>adjectils</span><span class = header>&nbsp;|&nbsp;</span><span class = header>The Harp</span><br>
  </div>

  <section class = "flex_box_index">
    <div id = "buffer1" style = "width:350px; height:50px; background-color: #404040; z-index: 5;"></div>
    <div class = "flex_index_row" id = "row1">
    
    </div>
    <div id = "buffer2" style = "width:350px; height:50px; background-color: #404040; z-index: 5;"></div>
    <span id = "scoreboard" style = "color: #55ff55">0</span><span id = "missboard" style = "color:#ff5555">0</span>
  </section>

  <div id = "nav" style = "width:min(calc(100% - 30px), max(600px, 40%)); margin: auto" class = "hub_block"></div>
  </body>
  <script>
    const harpcolors = ["#ff55ff", "#ffaa00", "#ffff55", "#55ff55", "#55ffff", "#5555ff", "#aa00aa"];
    const harpcolorssoft = ["#ff88ff", "#ffcc55", "#ffff88", "#88ff88", "#88ffff", "#8888ff", "#cc55cc"];
    var score = 0;
    var miss = 0;
    var columnstatus = {
      0: 0,
      1: 0,
      2: 0,
      3: 0,
      4: 0,
      5: 0,
      6: 0,
    }
    function updatePage(){
        setup();
    }
    function setup() {
      document.getElementById("row1").innerHTML = "";
      for (let i = 0; i <= 6; i++) {
          let box = document.createElement("span");
          box.className = "melodytrack";
          box.style.backgroundColor = harpcolors[i];
          box.id = "col" + i;
          row1.appendChild(box);
          let marker = document.createElement("span");
          let targetX = document.getElementById("col" + i).getBoundingClientRect().left;
          marker.style.position = "absolute";
          marker.style.width = "50px";
          marker.style.height = "50px";
          marker.style.transform = "translateY(125px)";
          marker.style.backgroundColor = harpcolorssoft[i];
          marker.id = "marker" + i;
          marker.style.zIndex = 6;
          marker.onclick = function () {
            checkScore(i);
          }
          document.getElementById("col" + i).appendChild(marker);
      }
    }
    function createRipple(column){

      var ripple = document.createElement("div");
      ripple.className = "ripple";
      ripple.style.position = "fixed";
      ripple.id = "ripple" + column;
      ripple.style.zIndex = 5;

      document.getElementById("marker" + column).appendChild(ripple);

      ripple.classList.add("expanded"); 

      setTimeout(() => { document.getElementById("marker" + column).removeChild(ripple);}, 1000);

    }
    async function checkScore(i) {
        if (columnstatus[i] != 0) {
            try {
              document.getElementById("col" + i).removeChild(document.getElementById("note" + columnstatus[i]));
            
            } catch {
              console.log("Failed to remove a note, it was probably already removed");
            }
            score++;
            scoreboard.innerText = score;
            columnstatus[i] = 0;
            createRipple(i);
          
        } else {
          //playPianoSound("C4");
          miss++;
          missboard.innerText = miss;
        }
    }
    async function playNote(column, tempo, i) {
        if (column == -1) {
          return;
        }
        var note = document.createElement("span");
        let targetX = document.getElementById("col" + column).getBoundingClientRect().left;
        note.style.position = "absolute";
        note.style.width = "50px";
        note.style.height = "50px";
        note.style.transform = "translateY(-50px)";
        note.style.backgroundColor = "#808080";
        note.id = "note" + i;
        note.style.zIndex = 4;
        document.getElementById("col" + column).appendChild(note);
        let start = null;
        let duration = 480000/tempo; 
        let initialTop = 0; 
        let finalTop = 450;
        let passed = false;
        function animate(timestamp) {
            if (!start) start = timestamp;
            let progress = timestamp - start;
            let position = Math.min(initialTop + (finalTop * (progress / duration)), finalTop);
            note.style.top = position + 'px';
            if (progress < duration) {
                window.requestAnimationFrame(animate);
            }
            if (progress >= duration) {
              try {
                document.getElementById("col" + column).removeChild(note);
                //playPianoSound("C4");
                miss++;
                missboard.innerText = miss;
              } catch {

              }
              
            }
            if (progress >= duration * 0.66 && progress <= duration * 0.88) {
              columnstatus[column] = i;
            } else if (progress > duration * 0.88 && passed == false){
              columnstatus[column] = 0;
              passed = true;
            }
        }

        window.requestAnimationFrame(animate);
      
    }
    var lock = 0;
    async function playTrack(array) {
      if (lock == 1) {
        console.log("Song already playing!");
        return -1;
      }
      lock = 1;
      var tempo = array[0];
      for (let i = 1; i < array.length; i++) {
        playNote(array[i], tempo, i);
        await delay(60000/tempo);
        if (throttle == 1) {
          console.log("Song interrupted!");
          break;
        }
      }
      lock = 0;
    }
    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    var throttle = 0;
    var sampletrack = [200, 1, 2, 3, 2, 3, 4, 5, 2, 5, 3, 4, 2, 3, 4, 3, 2, 1, 2, 3, 2, 3, 4, 5, 2, 5, 3, 4, 2, 3, 4, 3, 2, 1, 2, 3, 2, 3, 4, 5, 2, 5, 3, 4, 2, 3, 4, 3, 2, 1, 2, 3, 2, 3, 4, 5, 2, 5, 3, 4, 2, 3, 4, 3, 2];
    var silly = [1440, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4, 5, 6, 5, 4, 3, 2, 1, 0, ];
    var testtrack1 = [60, 0, -1, 1, -1, 2];
    document.addEventListener('visibilitychange', () => {
      isPageVisible = !document.hidden;

    if (isPageVisible) {
      throttle = 0;
    } else {
      // Page is hidden, use setTimeout to keep animation running
      throttle = 1;
    }
    
});
  
  </script>