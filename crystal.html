<!DOCTYPE html>
  <html>
  <body onload="updatePage()">
  <title>adjectils - Crystal Hollows</title>
  <link rel="stylesheet" href="stylesheet.css">
  <!--You can thank Brooke for the description.-->
  <meta name = "description" content = "Crystalline utilities for Hypixel SkyBlock">
  <meta name = "author" content = "adjective_n0un">
  <script type="text/javascript" src="/jquery-3.6.3.min.js"></script>
      <script>
      $(function(){
        $("#nav").load("nav.html"); 
      });
      </script>
    <div id = header>
    <a href = "index.html" class = adjheader>adjectils</a><span class = header>&nbsp;|&nbsp;</span><span class = crystalheader>Crystal Hollows</span><br>
  </div>
  <input type = "text" onchange = updatePass(value)><br>
  <span id = "status">Enter a username to continue.</span><br>
  <div class = "crystal_block" style = "width:600px; height:100px">
    <span class = hollowheader>Pass tracker</span><br><br>
    <div style = "float:left">
        <span>Pass expiration:&nbsp;</span><br>
        <span>Time remaining:&nbsp;</span>
    </div>
    <div style = "display:inline-block">
        <span id = "passexpiration">––:––</span><br>
        <span id = "timeleft">––:––</span>
    </div>
  </div>
  <div class = crystal_block style = "width:600px">
    <span class = hollowheader>Crystal Nucleus loot</span><br><br>
    <table>
        <tr><td><span> User has High Roller: </span>&nbsp;&nbsp;&nbsp;</td><td><span id = "hashighroller">False</span></td></tr>
        <tr><td><span> User has Ruby Crystal: </span>&nbsp;&nbsp;&nbsp;</td><td><span id = "hasrubycrystal">False</span></td></tr>
        <tr><td><span> User has Jasper Crystal: </span>&nbsp;&nbsp;&nbsp;</td><td><span id = "hasjaspercrystal">False</span></td></tr>
        <tr><td><span> User has Mole Pet: </span>&nbsp;&nbsp;&nbsp;</td>
            <td><label class = "switchbox">
                <input type = "checkbox" value = "false" id = "hasmole" onchange = updateMole()>
                <span class = "switch"></span></label>
            </td></tr>
    </table>
    <br>
    <table>
        <tr>
            <td><span>Chance of Flawless Ruby Gemstone: &nbsp;</span></td><td><span id = "chance_fl_ruby">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Flawless Amethyst Gemstone: &nbsp;</span></td><td><span id = "chance_fl_amethyst">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Flawless Jade Gemstone: &nbsp;</span></td><td><span id = "chance_fl_jade">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Flawless Amber Gemstone: &nbsp;</span></td><td><span id = "chance_fl_amber">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Flawless Sapphire Gemstone: &nbsp;</span></td><td><span id = "chance_fl_sapphire">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Flawless Topaz Gemstone: &nbsp;</span></td><td><span id = "chance_fl_topaz">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Flawless Jasper Gemstone: &nbsp;</span></td><td><span id = "chance_fl_jasper">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Bob-omb ×16: &nbsp;</span></td><td><span id = "chance_bombs">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Pickonimbus 2000: &nbsp;</span></td><td><span id = "chance_pick2k">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Oil Barrel: &nbsp;</span></td><td><span id = "chance_oil">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Divan Fragment: &nbsp;</span></td><td><span id = "chance_divan_fragment">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Prehistoric Egg: &nbsp;</span></td><td><span id = "chance_arma_egg">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Helix Fossil: &nbsp;</span></td><td><span id = "chance_helix">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Ruby Crystal: &nbsp;</span></td><td><span id = "chance_crystal_ruby">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Jasper Crystal: &nbsp;</span></td><td><span id = "chance_crystal_jasper">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Treasurite ×5: &nbsp;</span></td><td><span id = "chance_treasurite5">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Treasurite ×10: &nbsp;</span></td><td><span id = "chance_treasurite10">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Jaderald: &nbsp;</span></td><td><span id = "chance_jaderald">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Gold Essence ×10: &nbsp;</span></td><td><span id = "chance_essence_gold">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Diamond Essence ×10: &nbsp;</span></td><td><span id = "chance_essence_diamond">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Gemstone Mixture: &nbsp;</span></td><td><span id = "chance_gemmix">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Fortune IV book: &nbsp;</span></td><td><span id = "chance_book_fortune">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Wishing Compass ×3: &nbsp;</span></td><td><span id = "chance_compass">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Precious Pearl: &nbsp;</span></td><td><span id = "chance_preciouspearl">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Claw Fossil: &nbsp;</span></td><td><span id = "chance_claw">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Recall Potion: &nbsp;</span></td><td><span id = "chance_recall">Loading...</span></td>
        </tr>
        <tr>
            <td><span>Chance of Quick Claw: &nbsp;</span></td><td><span id = "chance_quick_claw">Loading...</span></td>
        </tr>
    </table>
  </div>

  <div id = "nav" style = "width:600px" class = "crystal_block"></div>
  </body>
  <script src = "getUUID.js"></script>
  <script src = "timeToMinutes.js"></script>
  <script src = "binomials.js"></script>
  <script src = "crystaldata.js"></script>
  <script>
    var storedname = "";
    var hr = 0;
    var mole = 0;
    const intervalID = [];
    async function updatePass(name){
        if (name == storedname) {
            return;
        }
        document.getElementById("passexpiration").innerText = "Loading...";
        document.getElementById("timeleft").innerText = "Loading...";
        clearInterval[intervalID[0]];
        intervalID.length = 0;
        var UUID = await getUUIDbyName(name);
        const apicall = await fetch("https://api.hypixel.net/skyblock/profiles?key=" + window["key"] + "&uuid=" + UUID);
        if (!apicall.ok){
          console.log("Api call error");
        }
        const data = await apicall.json();
        var purchasetime = data.profiles[data.profiles.length - 1].members[UUID].mining_core.greater_mines_last_access;
        console.log(purchasetime);
        var hasruby;
        var hasjasper;
        //identify if player has the ruby/jasper crystal
        try {
            hasruby = data.profiles[data.profiles.length - 1].members[UUID].mining_core.crystals.ruby_crystal.state;
        } catch (TypeError) {
            hasruby = "NOT_FOUND";
        }
        try {
            hasjasper = data.profiles[data.profiles.length - 1].members[UUID].mining_core.crystals.jasper_crystal.state;
        } catch (TypeError) {
            hasjasper = "NOT_FOUND";
        }
        console.log(hasruby);
        console.log(hasjasper);
        if (hasruby == "FOUND"){
            console.log("User has Ruby Crystal");
            nucweights["crystal_ruby"] = 0;
            document.getElementById("hasrubycrystal").innerText = "True";
        } else {
            nucweights["crystal_ruby"] = 2500;
            document.getElementById("hasrubycrystal").innerText = "False";
        }
        if (hasjasper == "FOUND"){
            console.log("User has Jasper Crystal");
            nucweights["crystal_jasper"] = 0;
            document.getElementById("hasjaspercrystal").innerText = "True";
        } else {
            nucweights["crystal_jasper"] = 2500;
            document.getElementById("hasjaspercrystal").innerText = "False";
        }
        console.log(purchasetime);
        
        
        if (purchasetime == undefined) {
            document.getElementById("passexpiration").innerText = "N/A";
            document.getElementById("timeleft").innerText = "––:––";
        } else {
            var finaltime = new Date(purchasetime + 21600000);
            document.getElementById("passexpiration").innerText = finaltime.getHours() + ":" + fixTime(finaltime.getMinutes()) + ":" + fixTime(finaltime.getSeconds()) + " – " + months[finaltime.getMonth()] + finaltime.getDate();
            if (Date.now() > purchasetime + 21600000){
                document.getElementById("timeleft").innerText = "Expired";
            } else {
                var interval = setInterval(() => updateTimers(purchasetime), 1000);
                intervalID[0] = interval;  
            }
        } 
        const completedtasks = new Set(data.profiles[data.profiles.length - 1].members[UUID].leveling.completed_tasks);
        
        if (completedtasks.has("DIAMOND_ESSENCE_HIGH_ROLLER_1")){
            document.getElementById("hashighroller").innerText = "True";
            hr = 1;
        } else {
            document.getElementById("hashighroller").innerText = "False";
        }
        
        
        if (name != storedname){
            updateChances();
            storedname = name;
        } 
    }
    function updateMole(){
        mole = Math.abs(mole - 1);
        updateChances();
    }
    function updateChances(){
        console.log("Mole: " + mole); 
        var totalweight = totalnucweight + nucweights["crystal_ruby"] + nucweights["crystal_jasper"];
        console.log("Total weight: " + totalweight);
        for (var key in nucweights){
            //console.log("Key: " + key); 
            try {
                var apxdropchance = 0;
                for (var j = 14 + hr + mole; j <= 20 + hr + mole; j++){
                    //console.log("J: " + j + " nucweights[key]: " + nucweights[key] + " Total nuc weight: " + totalweight + " Drop chance: " + (nucweights[key] / totalweight));
                    apxdropchance += ((1/7) * binomial(j, nucweights[key]/totalweight));
                }
                document.getElementById("chance_" + key).innerText = (apxdropchance * 100).toFixed(3) + "%";
                //console.log((apxdropchance * 100).toFixed(3) + "%");
            } catch (ReferenceError) {
               //console.log("adj opted not to put " + key + " in the table.");
            }
            
        }
        console.log("Done");
    }
    async function updateTimers(purchasetime){
        var timeelapsed = ((Date.now() - purchasetime)/1000).toFixed(0);
        var timeleft = 21600 - timeelapsed;
        if (timeleft > 0){
            document.getElementById("timeleft").innerText = timeToMinutes(timeleft);
        } else {
            document.getElementById("timeleft").innerText = "Expired";
            
            clearInterval[intervalID[0]];
            intervalID.length = 0;
        }
        
        
    }
    function updatePage(){
        updatePass("bro0ke");
    }
  </script>